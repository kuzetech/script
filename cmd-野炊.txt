kubectl -n personal-public get pods

ingest-client-all-ctxn5
ingest-client-all-l2wn6
ingest-client-xkbrs
ingest-client-7jbcz

kubectl -n personal-public describe pod ingest-client-all-ctxn5
kubectl -n personal-public logs -p --tail 50 ingest-client-all-ctxn5 
kubectl -n personal-public exec -it ingest-client-all-ctxn5 -- bash

kubectl -n personal-public get pod game-0 -o yaml
kubectl -n personal-public top pod  | grep ingest-client-all
kubectl -n personal-public logs -f ingest-0 | grep -v 'producer stats received stats'


## kubectl pvc 相关
kubectl -n personal-public get volumns
kubectl -n feature-stat-log get pvc feature-stat-log-data -o yaml
kubectl -n feature-stat-log describe pvc ingest-client-log-ingest-client-0

## 根据镜像创建一个新的 pod
kubectl -n feature-stat-log run gotest --image=registry.wll:5000/campfire/ingest-client:1.0.0-s221108-1443-2bd5a4d7 --command -- sleep 1000000
kubectl -n feature-stat-log exec -it gotest -- sh
kubectl -n feature-stat-log delete pod gotest

## 在 pod 中安装 inotify 并测试
apt-get update
apt install inotify-tools
inotifywait -mrq -e create,modify,delete /ingest-client/data/game-server/k8s-node2/game-0/stat_log/campfire_feature_stat_log_s1/info

## pprof 应用

kubectl port-forward svc/turbine-api 9901:80
kubectl port-forward pod/ingest-0 7777:7777

http://localhost:7777/debug/pprof

### 将监控文件直接下载到本地
go tool pprof http://127.0.0.1:7777/debug/pprof/goroutine
go tool pprof http://127.0.0.1:7777/debug/pprof/allocs
go tool pprof http://127.0.0.1:7777/debug/pprof/block
go tool pprof http://127.0.0.1:7777/debug/pprof/cmdline
go tool pprof http://127.0.0.1:7777/debug/pprof/heap
go tool pprof http://127.0.0.1:7777/debug/pprof/mutex
go tool pprof http://127.0.0.1:7777/debug/pprof/profile
go tool pprof http://127.0.0.1:7777/debug/pprof/threadcreate
go tool pprof http://127.0.0.1:7777/debug/pprof/trace

### 然后通过 go tool 打开
go tool pprof -http :8085 /Users/huangsw/pprof/pprof.ingest.alloc_objects.alloc_space.inuse_objects.inuse_space.002.pb.gz
go tool pprof -http :8086 /Users/huangsw/pprof/pprof.ingest.alloc_objects.alloc_space.inuse_objects.inuse_space.004.pb.gz

### 也可以直接在本地开启站点，直接查看
go tool pprof -http :8085 http://127.0.0.1:7777/debug/pprof/profile
go tool pprof -http :8085 http://127.0.0.1:7777/debug/pprof/profile\?seconds\=25


### 排查顺序
kubectl -n personal-public top pod | grep ingest-client

kubectl -n personal-public exec -it ingest-client-all-ctxn5 -- bash
apt-get update && apt-get install curl -y && curl -o heap.out http://localhost:10000/debug/pprof/heap

kubectl -n personal-public cp ingest-client-all-ctxn5:/heap.out /tmp/pprof/heap-ctxn5.out

kubectl -n personal-public exec ingest-client-all-ctxn5 -- curl -o heap.out http://localhost:10000/debug/pprof/heap



// 然后通过 “文件管理” 功能下载，最后在本地通过 go 命令查看
go tool pprof /Users/huangsw/Downloads/heap.out

